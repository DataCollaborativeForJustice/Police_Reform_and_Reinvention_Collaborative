---
title: "OATH"
author: "Stephen Koppel"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

setwd("C:/R Projects/civil")

```{r}

library(showtext)
font_add(family = "Impact", regular = "impact.ttf")
font_add(family = "Knockout", regular = "C:/R Projects/Police Reform/Graphs/Knockout-32JuniorCruisewt.otf")
showtext_auto()
showtext_opts(dpi = 300)

```

```{r}

oath <- read_csv("2023 OATH SUMMONS DATA.csv")


```


```{r}

oath <- oath %>% 
  clean_names() %>% 
  transmute(borough = x2_borough_of_occurence,
            location_zip = as.character(x4_premises_zip),
            home_zip = as.character(x20_respondent_zip),
            sex = x21_sex,
            race = x22_race,
            DOB = mdy(x23_date_of_birth),
            agency = x24_issuing_agency,
            ever_FTA = x29_ever_failed_to_appear_flag,
            date = x5_summons_issue_date,
            charge = x8_charge_violation_code,
            disposition = x13_disposition,
            fine = x14_face_amount,
            fine_imposed = x15_imposed_amount,
            dismissal_reason = x17_dismissal_reason,
            ) %>% 
  filter(agency == "POLICE DEPARTMENT") %>% 
mutate(charge_desc = case_when(charge == "AA01" ~ "Unauthorized presence in park when closed to public",
                               charge == "AA02" ~ "Failure to have/display/comply with required permit",
                               charge == "AA03" ~ "Failure to comply with directive of police, park supervisor, lifeguard",
                               charge == "AA04" ~ "Failure to comply with directions/prohibitions on signs",
                               charge == "AA05" ~ "Injury, defacement, abuse of department property",
                               charge == "AA07" ~ "Defacement, killing, etc. of park vegetation",
                               charge == "AA08" ~ "Walking on/permitting animal or child to walk on newly seeded grass",
                               charge == "AA09" ~ "Walking/permitting animal or child to walk in fenced area",
                               charge == "AA11" ~ "Littering or unlawful use of park receptacle",
                               charge == "AA14" ~ "Storing/leaving unattended belongings",
                               charge == "AA15" ~ "Possession of glass container",
                               charge == "AA17" ~ "Unlawful feeding of animals",
                               charge == "AA18" ~ "Unleashed/uncontrolled animals in park",
                               charge == "AA19" ~ "Failure to remove canine waste",
                               charge == "AA21" ~ "Unlawful urination/defecation in park",
                               charge == "AA22" ~ "Disorderly behavior - unauthorized access/trespass",
                               charge == "AA23" ~ "Obstruction of benches, sitting areas",
                               charge == "AA24" ~ "Unlawful camping",
                               charge == "AA25" ~ "Spitting on park building/monument/structure",
                               charge == "AA28" ~ "Unlawful vending",
                               charge == "AA29" ~ "Unlawful display of signs",
                               charge == "AA30" ~ "Unreasonable noise",
                               charge == "AA31" ~ "Operating sound reproduction device without permit",
                               charge == "AA35" ~ "Unauthorized consumption/possession of alcohol",
                               charge == "AA37" ~ "Failure to comply with fishing restrictions",
                               charge == "AA40" ~ "Failure to comply with ice skating restrictions",
                               charge == "AA42" ~ "Failure to comply with fire restrictions",
                               charge == "AA49" ~ "Failure to comply with in-line skating restrictions",
                               charge == "AA65" ~ "Failure to comploy with directive of other Department employee",
                               charge == "AA67" ~ "Aviation - bringing/landing aerial device in park, endangering person/property",
                               charge == "AA69" ~ "Possession of a firearm/propellant/explosive",
                               charge == "AA71" ~ "Disorderly Behavior - climbing",
                               charge == "AA72" ~ "Failure of pedicab or bike operator to comply with sign",
                               charge == "AA73" ~ "Disorderly behavior - climbing statue or artwork",
                               charge == "AA74" ~ "Failure to comply with bicycle riding or pedicab restriction",
                               charge == "AA77" ~ "Disorderly behavior - gambling",
                               charge == "AA78" ~ "Disorderly behavior - render road dangerous",
                               charge == "AA80" ~ "Disorderly behavior - fighting/assault",
                               charge == "AA81" ~ "Disorderly behavior - sexual activity",
                               charge == "AA82" ~ "Disorderly behavior - endanger safety of others",
                               charge == "AA83" ~ "Disorderly behavior - operation of bike/motor vehicle, endangering person/property",
                               charge == "AA85" ~ "Unlawful commercial activity or speech",
                               charge == "AA86" ~ "Soliciting money or property without permit",
                               charge == "AA87" ~ "Unpermitted event that significantly interferes with park use",
                               charge == "AA88" ~ "Structure/stand/booth without permit",
                               charge == "AA89" ~ "Appearing in park under influence of alcohol, endangering self/others",
                               charge == "AA92" ~ "Going on frozen lake or pond without authorization",
                               charge == "AA93" ~ "Unauthorized driving/parking/automotive work",
                               charge == "AA94" ~ "Area use restrictions - unauthorized toy or model aviation, boating, automobiling",
                               charge == "AA95" ~ "Area use restrictions - unauthorized skating, skiing, skateboarding, sledding, endangering person/property",
                               charge == "AA96" ~ "Area use restrictions - unauthorized skating, skiing, skateboarding, sledding",
                               charge == "AA97" ~ "Failure to comply with exclusive children playground restriction",
                               charge == "AAA5" ~ "Unlawful vending 2nd",
                               charge == "AAA6" ~ "Unlawful vending of expressive matter",
                               charge == "AN01" ~ "Causing or permitting unreasonable noise (7am-10pm) 1st",
                               charge == "AN02" ~ "Causing or permitting unreasonable noise (7am-10pm) 2nd",
                               charge == "AN03" ~ "Causing or permitting unreasonable noise (7am-10pm) 3rd",
                               charge == "AN04" ~ "Causing or permitting unreasonable noise (10pm-7am) 1st",
                               charge == "AN05" ~ "Causing or permitting unreasonable noise (10pm-7am) 2nd",
                               charge == "AN06" ~ "Causing or permitting unreasonable noise(10pm-7am) 3rd",
                               charge == "AS03" ~ "Littering 1st",
                               charge == "AS05" ~ "Throw-out 1st",
                               charge == "AS3A" ~ "Littering 2nd",
                               charge == "AS9H" ~ "Spitting 1st",
                               charge == "AS9I" ~ "Public urination 1st",
                               charge == "AS9J" ~ "Spitting 2nd",
                               charge == "AS9K" ~ "Spitting 3rd",
                               charge == "AS9L" ~ "Public urination 2nd",
                               charge == "AS9M" ~ "Public urination 3rd",
                               charge == "AX25" ~ "Open container, consumption of alcohol on street",
                               charge == "BN92" ~ "Causing or permitting unreasonable noise (7am-10pm) 1st",
                              )) %>% 
  mutate(law_cat = str_sub(charge, 1, 2)) %>% 
  mutate(law = case_when(charge %in% c("AA21", "AS9I", "AS9L", "AS9M") ~ "Public Urination",
                         law_cat == "AA" ~ "Parks Offenses",
                         law_cat %in% c("AN", "BN") ~ "Noise",
                         law_cat == "AS" ~ "Littering/Spitting",
                         law_cat == "AX" ~ "Open Container of Alcohol")) %>% 
  mutate(date = mdy(date)) %>%
  mutate(year = year(date)) %>% 
  mutate(month = month(date)) %>% 
  mutate(year_month = make_date(year(date), month(date))) %>% 
  mutate(race_cat = case_when(race == "Black" ~ "Black",
                          race == "White" ~ "White",
                          race %in% c("Hispanic Black", "Hispanic White") ~ "Hispanic",
                          race %in% c("American Indian/Alaskan", "Asian/Pacific Island") ~ "Additional Groups")) %>% 
    mutate(age = interval(DOB, date) %>% as.numeric('years') %>% round(0)) %>% 
    mutate(age_cat = case_when(age >=10 & age <= 24 ~ "<25",
                             age >=25 & age <= 44 ~ "25-44",
                             age >=45 & age <= 98 ~ "45+")) 
   
  
  

# write.csv(.,"charge_distribution.csv", row.names = FALSE)
  


```




```{r}

# check charge distribution for reclassification

# oath %>% count(law, law_cat, charge, charge_desc) %>% 
# write.csv(.,"charge_distribution.csv", row.names = FALSE)

```



```{r}

oath <- oath %>% 
  mutate(law = case_when(charge == "AA11" ~ "Littering/Spitting",
                         charge == "AA25" ~ "Littering/Spitting",
                         charge == "AA30" ~ "Noise",
                         charge == "AA31" ~ "Noise",
                         charge == "AA35" ~ "Open Container of Alcohol",
                         TRUE ~ law))




```




```{r}

oath <- oath %>% mutate(mod_zip_location = case_when(
  location_zip %in% c("10001","10118","10119","10199") ~ "10001",
  location_zip == "10002" ~ "10002",
  location_zip == "10003" ~ "10003",
  location_zip == "10004" ~ "10004",
  location_zip %in% c("10005","10271") ~ "10005",
  location_zip == "10006" ~ "10006",
  location_zip %in% c("10007","10278","10279") ~ "10007",
  location_zip == "10009" ~ "10009",
  location_zip == "10010" ~ "10010",
  location_zip == "10011" ~ "10011",
  location_zip == "10012" ~ "10012",
  location_zip == "10013" ~ "10013",
  location_zip == "10014" ~ "10014",
  location_zip == "10016" ~ "10016",
  location_zip %in% c("10017","10165","10167", "10168", "10169", "10170", "10171", "10172", "10173", "10174", "10177") ~ "10017",
  location_zip == "10018" ~ "10018",
  location_zip %in% c("10019","10020","10103","10111","10112") ~ "10019",
  location_zip == "10021" ~ "10021",
  location_zip %in% c("10022","10152","10153","10154") ~ "10022",
  location_zip == "10023" ~ "10023",
  location_zip == "10024" ~ "10024",
  location_zip == "10025" ~ "10025",
  location_zip == "10026" ~ "10026",
  location_zip %in% c("10027","10115") ~ "10027",
  location_zip == "10028" ~ "10028",
  location_zip == "10029" ~ "10029",
  location_zip == "10030" ~ "10030",
  location_zip == "10031" ~ "10031",
  location_zip == "10032" ~ "10032",
  location_zip == "10033" ~ "10033",
  location_zip == "10034" ~ "10034",
  location_zip == "10035" ~ "10035",
  location_zip %in% c("10036","10110") ~ "10036",
  location_zip == "10037" ~ "10037",
  location_zip == "10038" ~ "10038",
  location_zip == "10039" ~ "10039",
  location_zip == "10040" ~ "10040",
  location_zip == "10044" ~ "10044",
  location_zip == "10065" ~ "10065",
  location_zip == "10069" ~ "10069",
  location_zip %in% c("10075","10162") ~ "10075",
  location_zip == "10128" ~ "10128",
  location_zip == "10289" ~ "10280",
  location_zip == "10282" ~ "10282",
  location_zip == "10301" ~ "10301",
  location_zip == "10302" ~ "10302",
  location_zip == "10303" ~ "10303",
  location_zip == "10304" ~ "10304",
  location_zip == "10305" ~ "10305",
  location_zip == "10306" ~ "10306",
  location_zip == "10307" ~ "10307",
  location_zip == "10308" ~ "10308",
  location_zip == "10309" ~ "10309",
  location_zip == "10310" ~ "10310",
  location_zip == "10312" ~ "10312",
  location_zip %in% c("10311","10314") ~ "10314",
  location_zip == "10451" ~ "10451",
  location_zip == "10452" ~ "10452",
  location_zip == "10453" ~ "10453",
  location_zip == "10454" ~ "10454",
  location_zip == "10455" ~ "10455",
  location_zip == "10456" ~ "10456",
  location_zip == "10457" ~ "10457",
  location_zip == "10458" ~ "10458",
  location_zip == "10459" ~ "10459",
  location_zip == "10460" ~ "10460",
  location_zip == "10461" ~ "10461",
  location_zip == "10462" ~ "10462",
  location_zip == "10463" ~ "10463",
  location_zip == "10464" ~ "10464",
  location_zip == "10465" ~ "10465",
  location_zip == "10466" ~ "10466",
  location_zip == "10467" ~ "10467",
  location_zip == "10468" ~ "10468",
  location_zip == "10469" ~ "10469",
  location_zip == "10470" ~ "10470",
  location_zip == "10471" ~ "10471",
  location_zip == "10472" ~ "10472",
  location_zip == "10473" ~ "10473",
  location_zip == "10474" ~ "10474",
  location_zip == "10475" ~ "10475",
  location_zip %in% c("11004","11005","11040") ~ "11004",
  location_zip == "11101" ~ "11101",
  location_zip == "11102" ~ "11102",
  location_zip == "11103" ~ "11103",
  location_zip == "11104" ~ "11104",
  location_zip == "11105" ~ "11105",
  location_zip == "11106" ~ "11106",
  location_zip == "11109" ~ "11109",
  location_zip == "11201" ~ "11201",
  location_zip == "11203" ~ "11203",
  location_zip == "11204" ~ "11204",
  location_zip == "11205" ~ "11205",
  location_zip == "11206" ~ "11206",
  location_zip == "11207" ~ "11207",
  location_zip == "11208" ~ "11208",
  location_zip %in% c("11209","11425") ~ "11209",
  location_zip == "11210" ~ "11210",
  location_zip %in% c("11211","11249") ~ "11211",
  location_zip == "11212" ~ "11212",
  location_zip == "11213" ~ "11213",
  location_zip == "11214" ~ "11214",
  location_zip == "11215" ~ "11215",
  location_zip == "11216" ~ "11216",
  location_zip %in% c("11217","11243") ~ "11217",
  location_zip == "11218" ~ "11218",
  location_zip == "11219" ~ "11219",
  location_zip == "11220" ~ "11220",
  location_zip == "11221" ~ "11221",
  location_zip == "11222" ~ "11222",
  location_zip == "11223" ~ "11223",
  location_zip == "11224" ~ "11224",
  location_zip == "11225" ~ "11225",
  location_zip == "11226" ~ "11226",
  location_zip == "11228" ~ "11228",
  location_zip == "11229" ~ "11229",
  location_zip == "11230" ~ "11230",
  location_zip == "11231" ~ "11231",
  location_zip == "11232" ~ "11232",
  location_zip == "11233" ~ "11233",
  location_zip == "11234" ~ "11234",
  location_zip == "11235" ~ "11235",
  location_zip == "11236" ~ "11236",
  location_zip == "11237" ~ "11237",
  location_zip == "11238" ~ "11238",
  location_zip == "11239" ~ "11239",
  location_zip == "11354" ~ "11354",
  location_zip == "11355" ~ "11355",
  location_zip == "11356" ~ "11356",
  location_zip %in% c("11351","11357") ~ "11357",
  location_zip == "11358" ~ "11358",
  location_zip %in% c("11359","11360") ~ "11360",
  location_zip == "11261" ~ "11261",
  location_zip == "11262" ~ "11262",
  location_zip == "11263" ~ "11263",
  location_zip == "11264" ~ "11264",
  location_zip == "11265" ~ "11265",
  location_zip == "11366" ~ "11366",
  location_zip == "11367" ~ "11367",
  location_zip == "11368" ~ "11368",
  location_zip %in% c("11369","11371") ~ "11369",
  location_zip == "11370" ~ "11370",
  location_zip == "11372" ~ "11372",
  location_zip == "11373" ~ "11373",
  location_zip == "11374" ~ "11374",
  location_zip == "11375" ~ "11375",
  location_zip == "11377" ~ "11377",
  location_zip == "11378" ~ "11378",
  location_zip == "11379" ~ "11379",
  location_zip == "11385" ~ "11385",
  location_zip %in% c("11003","11411") ~ "11411",
  location_zip == "11412" ~ "11412",
  location_zip == "11413" ~ "11413",
  location_zip == "11414" ~ "11414",
  location_zip %in% c("11415","11424") ~ "11415",
  location_zip == "11416" ~ "11416",
  location_zip == "11417" ~ "11417",
  location_zip == "11418" ~ "11418",
  location_zip == "11419" ~ "11419",
  location_zip == "11420" ~ "11420",
  location_zip == "11421" ~ "11421",
  location_zip == "11422" ~ "11422",
  location_zip == "11423" ~ "11423",
  location_zip == "11426" ~ "11426",
  location_zip == "11427" ~ "11427",
  location_zip == "11428" ~ "11428",
  location_zip %in% c("11001","11429") ~ "11429",
  location_zip == "11432" ~ "11432",
  location_zip %in% c("11433","11451") ~ "11433",
  location_zip %in% c("11430","11434") ~ "11434",
  location_zip == "11435" ~ "11435",
  location_zip == "11436" ~ "11436",
  location_zip == "11691" ~ "11691",
  location_zip == "11692" ~ "11692",
  location_zip == "11693" ~ "11693",
  location_zip == "11694" ~ "11694",
  location_zip == "11697" ~ "11697"
  )
) 



```

 
 

```{r}


mod_zip <- c('10001',
'10002',
'10003',
'10026',
'10004',
'10005',
'10006',
'10007',
'10009',
'10010',
'10011',
'10012',
'10013',
'10014',
'10016',
'10017',
'10018',
'10030',
'10019',
'10021',
'10022',
'10023',
'10024',
'10025',
'10027',
'10028',
'10029',
'10031',
'10032',
'10033',
'10034',
'10037',
'10035',
'10036',
'10038',
'10040',
'11104',
'11105',
'10039',
'10128',
'10044',
'10065',
'10069',
'10075',
'10280',
'10282',
'10301',
'11106',
'10302',
'10303',
'10304',
'10451',
'10305',
'10306',
'10307',
'10308',
'10309',
'10310',
'10312',
'10314',
'10456',
'10452',
'10453',
'10454',
'10455',
'10457',
'10458',
'10459',
'10460',
'10461',
'11004',
'11101',
'10462',
'10463',
'10464',
'10465',
'10466',
'10467',
'10468',
'10469',
'10470',
'11102',
'11109',
'10471',
'10472',
'10473',
'10474',
'11103',
'10475',
'11201',
'11203',
'11204',
'11205',
'11206',
'11207',
'11209',
'11208',
'11210',
'11211',
'11212',
'11213',
'11218',
'11214',
'11215',
'11216',
'11217',
'11219',
'11220',
'11221',
'11222',
'11223',
'11224',
'11225',
'11226',
'11228',
'11230',
'11415',
'11229',
'11231',
'11358',
'11232',
'11233',
'11234',
'11235',
'11236',
'11237',
'11238',
'11239',
'11354',
'11355',
'11356',
'11357',
'11360',
'11372',
'11361',
'11362',
'11416',
'11363',
'11364',
'11373',
'11365',
'11366',
'11367',
'11374',
'11368',
'11417',
'11369',
'11370',
'11375',
'11379',
'11377',
'11378',
'11421',
'11422',
'11385',
'11411',
'11412',
'11413',
'11414',
'11420',
'11418',
'11419',
'11423',
'11426',
'11427',
'11428',
'11436',
'11691',
'11692',
'11693',
'11429',
'11432',
'11433',
'11434',
'11435',
'11694',
'11697')


```



```{r}

library(tidycensus)

vars <- c(white = "B03002_003",
          black = "B03002_004",
          hispanic = "B03002_012",
          Income = "B19013_001")

med_income <- get_acs(
    geography = "zcta",
    keep_geo_vars=TRUE,
    year = 2021,
    survey = "acs5",
    output = "wide",
    variables = vars) %>% 
  select(location_zip = GEOID, location_med_income = IncomeE, nhwhite = whiteE, nhblack = blackE, hispanic = hispanicE) %>% 
  filter(location_zip %in% mod_zip) 

med_income <- med_income %>% 
   mutate(location_quintile_flag = cut(location_med_income, breaks = quintile_breaks_location_all, labels = FALSE, include.lowest = TRUE))



oath <- oath %>% 
  left_join(med_income, by = c("mod_zip_location" = "location_zip")) 




```


```{r}

quintile_breaks_location_all <- quantile(med_income$location_med_income, probs = seq(0, 1, 0.2))


```


```{r}



oath <- oath %>%
  mutate(location_quintile_flag = cut(location_med_income, breaks = quintile_breaks_location_all, labels = FALSE, include.lowest = TRUE)) 




```


```{r}


oath %>% 
  count(year_month) %>% 
  ggplot(aes(year_month, n))+
  geom_line(color = "#3b4982", size = .8)+
  geom_point(color = "#3b4982", shape = 21, fill = "#3b4982")+
  scale_x_date(
    date_labels = "%Y",
    breaks = seq(as.Date("2019-01-01"), max(oath$year_month) - 1, by = "1 year")
  )+
    theme_classic() +
  scale_y_continuous(labels = comma, breaks = seq(0,4000, 500))+
  expand_limits(y=4000) +
  labs(y = NULL, x = NULL) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  easy_remove_x_axis(what = c("line")) +
  geom_vline(xintercept = as.Date("2020-03-16"), linetype = "dashed", color = "darkgrey") +
  geom_text(
    x = as.Date("2020-03-16"),
    y = 3000,  
    label = "Covid-19 Lockdowns",
    vjust = -0.5,  
    hjust = 0.5,   
    angle = 90,
    family = "Knockout",
    size = 3,
    color = "darkgrey"
  ) +
    geom_vline(xintercept = as.Date("2020-05-28"), linetype = "dashed", color = "darkgrey") +
  geom_text(
    x = as.Date("2020-05-28"),
    y = 3000,  
    label = "Black Lives Matter Protests",
    vjust = -0.5,  
    hjust = 0.5,   
    angle = 90,
    family = "Knockout",
    size = 3,
    color = "darkgrey"
  )+
    geom_vline(xintercept = as.Date("2021-03-01"), linetype = "dashed", color = "darkgrey") +
  geom_text(
    x = as.Date("2021-03-01"),
    y = 3000,  
    label = "Police Reform & Reinvention Plan",
    vjust = -0.5,  
    hjust = 0.5,   
    angle = 90,
    family = "Knockout",
    size = 3,
    color = "darkgrey"
  )+
    geom_vline(xintercept = as.Date("2022-01-01"), linetype = "dashed", color = "darkgrey") +
  geom_text(
    x = as.Date("2022-01-01"),
    y = 3000,  
    label = "Adams Administration",
    vjust = -0.5,  
    hjust = 0.5,   
    angle = 90, 
    family = "Knockout",
    size = 3,
    color = "darkgrey"
  )+
  theme(legend.position = "top",
        axis.text = element_text(size = 10),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_line(linetype = "solid", size = .5),
        legend.key=element_blank(),
        text = element_text(family = "Knockout"),
        legend.text = element_text(size = 11),
        strip.text = element_text(size = 10),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) 


setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_2.1.tiff", width = 6, height = 3.25)

```



```{r}



library(ggchicklet)

oath %>% 
  count(year) %>% 
  ggplot(aes(year, n)) +
  geom_chicklet(stat = "identity", fill = "#3b4982") +
  geom_text(aes(label = scales::comma(n)),
            vjust = 1.7,
            color = "white",
            family = "Knockout",
            fontface = "bold",
            size = 4,
            labels = comma) +
    theme_classic() +
  theme(legend.position = "top", 
        plot.background = element_rect(fill = "white"), 
        panel.background = element_rect(fill = "white"), 
        axis.text = element_text(size = 10),
        plot.title = element_text(size = 12), 
        panel.grid.major.y = element_blank(), 
        legend.key=element_blank(),
        text = element_text(family = "Knockout"),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_y_continuous(labels = NULL)+
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_x_continuous(breaks = 2019:2022) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  expand_limits(y = 30000)



setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_2.2.tiff", width = 5.75, height = 3.25)

```



```{r}


library(forcats)  # Make sure 'forcats' package is loaded for 'fct_relevel' function

oath_law_n <- oath %>%
  group_by(year, law) %>%   
  summarise(n = n()) %>%
  mutate(
    law = fct_relevel(law, "Open Container of Alcohol", "Public Urination", "Parks Offenses", "Noise", "Littering/Spitting"),
    law = factor(law)
  ) 


  ggplot(oath_law_n,
         aes(law, n, fill = as.factor(year))) +
  geom_chicklet(position = position_dodge2(preserve = "single"), width = 0.7) +
  theme_classic() +
  theme(
    plot.background = element_rect(fill = "white"), 
    legend.position = "none",
    panel.background = element_rect(fill = "white"), 
    plot.title = element_text(size = 12), 
    panel.grid.major.y = element_blank(), 
    legend.key = element_blank(),
    text = element_text(family = "Knockout"),
    legend.text = element_text(family = "Knockout", size = 8.8),
    axis.text = element_text(size = 8.7),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")
  ) +
  scale_y_continuous(labels = NULL) +
  xlab("") +
  labs(y = '', x = '', color = '') +
  scale_fill_manual(values = c("#00aeff","#00aeff", "#00aeff", "#3b4982")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5), title = NULL)) +
  expand_limits(y = 25000)+
   geom_text(position = position_dodge(width = 0.7),
               aes(label =  comma(n)),
               color = "black", 
               size = 2.8,
               vjust = -.2)+
    expand_limits(y = -500) +
    geom_text(position = position_dodge(width = 0.7),
              aes(label = sprintf("'%s", substr(year, 3, 4)), y = -300),
              vjust = 1,
              size = 2,
              fontface = "bold")

  

setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_2.3.tiff", width = 7, height = 4)

```



```{r}



oath %>% 
  filter(!is.na(law)) %>% 
  group_by(year, law) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race = fct_reorder(law, percent)) %>% 
  mutate(law = fct_relevel(law, "Littering/Spitting", "Noise", "Parks Offenses", "Public Urination", "Open Container of Alcohol")) %>% 
  ggplot(aes(year, percent, fill = law)) +
  geom_bar(stat = "identity", position = "fill", 
           width = 0.85, 
           key_glyph = draw_key_point) +
 geom_text(aes(label = ifelse(percent > 2.5, 
                              sprintf("%.1f%%", percent), "")), 
           size = 3.5, 
           position = position_fill(vjust = 0.5), 
           color = "white", 
           family = "Knockout", 
           fontface = "bold") +
  theme_classic() +
  theme(axis.text = element_text(size = 11),
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "none",
        text = element_text(family = "Knockout"),
        legend.text = element_text(size = 9.6),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_x_continuous(breaks = 2013: 2022)  +
  scale_fill_manual(values = c("#abadb0","#419D78","#f79548","#00aeff","#3b4982"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks"))


setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_2.4.tiff", width = 5.75, height = 3.25)



```

```{r}

boro_summons <- oath %>% 
  filter(!is.na(borough)) %>% 
  group_by(year, borough) %>% 
  summarise(n = n()) %>% 
  mutate(year = as.character(year))

boro_pop <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  mutate(borough = case_when(borough == "bronx" ~ "Bronx",
                          borough == "kings" ~ "Brooklyn",
                          borough == "manhattan" ~ "Manhattan",
                          borough == "queens" ~ "Queens",
                          borough == "si" ~ "Staten Island")) %>% 
  group_by(year, borough) %>%
  filter(year == "2022") %>% 
  summarise(total_pop = sum(value)) %>% 
  select(borough, n = total_pop) %>% 
  mutate(year = as.character(year)) %>% 
  mutate(year = "5")

geom_boro_data <- rbind(boro_summons, boro_pop) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(borough = fct_relevel(borough, "Staten Island", "Queens", "Manhattan", "Brooklyn", "Bronx")) %>% 
  mutate(year = case_when(year == "2019" ~ 1,
                             year == "2020" ~ 2,
                             year == "2021" ~ 3,
                             year == "2022" ~ 4,
                             year == "5" ~ 5)) %>% 
  mutate(year = as.character(year))


  ggplot(geom_boro_data,
         aes(year, percent, fill = borough)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
 geom_text(aes(label = ifelse(percent > 3, sprintf("%.1f%%", percent), "")), size = 4, position = position_fill(vjust = 0.5), color = "white", fontface = "bold") +
  theme_classic() +
  theme(axis.text = element_text(size = 11),
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "none",
        text = element_text(family = "Knockout"),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm"),
        legend.text = element_text(size = 11)) +
  scale_fill_manual(values = c("#abadb0","#419D78","#f79548","#00aeff","#3b4982"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
    geom_vline(xintercept = c(4.5), linetype = "solid", color = "black", size = .7) +
    scale_x_discrete(labels=c('2019', '2020', '2021', '2022', '% NYC Population'))


setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_2.5.tiff", width = 6, height = 3.5)



```


```{r}

nyc_population <- data.frame(
  year = rep("5", 4), # Repeats "% NYC Population" four times for the Year column
  race_cat = c("Hispanic", "Black", "White", "Additional Groups"), # Race categories
  percent = c(29.0, 23.1, 37.5, 10.4) # Corresponding percentages
)

oath %>% 
  filter(!is.na(race_cat)) %>% 
  group_by(year, race_cat) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(year = as.character(year)) %>% 
  bind_rows(nyc_population) %>% 
  mutate(year = case_when(year == "2019" ~ 1,
                             year == "2020" ~ 2,
                             year == "2021" ~ 3,
                             year == "2022" ~ 4,
                             year == "5" ~ 5)) %>% 
  mutate(year = as.character(year)) %>% 
  mutate(race = fct_relevel(race_cat, "Additional Groups", "White", "Black", "Hispanic")) %>% 
  ggplot(aes(year, percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
 geom_text(aes(label = ifelse(percent > 3, sprintf("%.1f%%", percent), "")), size = 3.5, position = position_fill(vjust = 0.5), color = "white", fontface = "bold") +
  geom_text(aes(label = ifelse(percent < 3, sprintf("%.1f%%", percent), "")), size = 2.6, position = position_fill(vjust = 0.5), color = "white", fontface = "bold", family = "Knockout") +
  theme_classic() +
  theme(panel.grid.major = element_blank(), 
        axis.text = element_text(size = 10),
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "none",
        text = element_text(family = "Knockout"),
        legend.text = element_text(size = 11),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_fill_manual(values = c("#abadb0","#f79548","#00aeff","#3b4982"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
      geom_vline(xintercept = c(4.5), linetype = "solid", color = "black", size = .7) +
    scale_x_discrete(labels=c('2019', '2020', '2021', '2022', '% NYC Population'))

setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_3.1.tiff", width = 6, height = 3.5)



```


## census data prep

```{r}

census_PD_projected <- read_csv("PD_census_with_projection.csv")

```

```{r}

# excludes below 10

PD_census_race <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  group_by(year, race) %>% 
  summarise(total_pop = sum(value))

```

```{r}

# note that this part of the analysis we exclude a small number of juveniles younger than 10 

oath_year_race <- oath %>% 
    mutate(race_cat = case_when(race_cat == "White" ~ "nhwhite",
                          race_cat == "Black" ~ "nhblack",
                          race_cat == "Hispanic" ~ "hispanic",
                          TRUE ~ "Other")) %>% 
  filter(race_cat != "Other",
         age > 9) %>% 
  count(year, race_cat)

```




```{r}


oath_ratio <- left_join(oath_year_race, PD_census_race,  by = c("race_cat" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race_cat, rate) %>% 
  pivot_wider(names_from = race_cat, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  mutate(nudge_y = ifelse(race == "Hispanic/white", .2, -.2)) 




left_join(oath_year_race, PD_census_race,  by = c("race_cat" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race_cat, rate) %>% 
  pivot_wider(names_from = race_cat, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  mutate(race = fct_relevel(race,"Hispanic/white","Black/white")) %>% 
  ggplot(aes(year, value, fill = race, label = sprintf("%.1f", value))) +
  geom_chicklet(stat = "identity", position = "dodge", width = 0.7,  key_glyph = draw_key_point) +
  theme_classic() +
  theme(legend.position = "top",
        axis.text = element_text(size = 10),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_blank(),
        legend.key=element_blank(),
        text = element_text(family = "Knockout"),
        legend.text = element_text(size = 11),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_y_continuous(labels = NULL)+
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '', fill = '') +
  scale_x_continuous(breaks = 2019:2022) +
  scale_fill_manual(values = c("#3b4982", "#00aeff")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
    geom_text(position = position_dodge(width = 0.7),
            aes(label = sprintf("%.1f", value)),
            vjust = 1.7,
            color = "white",
            family = "Knockout",
            fontface = "bold",
            size = 4) 

setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_3.2.tiff", width = 5.75, height = 3.25)



```

```{r}

# thumbnail

left_join(oath_year_race, PD_census_race,  by = c("race_cat" = "race", "year" = "year")) %>% 
  mutate(rate = (n/total_pop)*100000) %>% 
  select(year, race_cat, rate) %>% 
  pivot_wider(names_from = race_cat, values_from = rate) %>% 
  mutate(`Black` = round(nhblack/nhwhite,1),
         `Hispanic` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black`, `Hispanic`), names_to = "race") %>% 
  mutate(race = fct_relevel(race,"Hispanic","Black")) %>% 
  ggplot(aes(year, value, fill = race, label = sprintf("%.1f", value))) +
  geom_chicklet(stat = "identity", position = "dodge", width = 0.7,  key_glyph = draw_key_point) +
  theme_classic() +
  theme(legend.position = "top",
        axis.text = element_text(size = 10),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_blank(),
        legend.key=element_blank(),
        text = element_text(family = "Knockout"),
        legend.text = element_text(size = 11),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_y_continuous(labels = NULL)+
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '', fill = '') +
  scale_x_continuous(breaks = 2019:2022) +
  scale_fill_manual(values = c("#3b4982", "#00aeff")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
    geom_text(position = position_dodge(width = 0.7),
            aes(label = sprintf("%.1f", value)),
            vjust = 1.7,
            color = "white",
            family = "Knockout",
            fontface = "bold",
            size = 4) 

setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_thumbnail.tiff", width = 5.75, height = 3.25)


```


```{r}

oath %>% 
  filter(!is.na(race_cat)) %>% 
  filter(!is.na(borough)) %>% 
  group_by(year, borough, race_cat) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  mutate(race = fct_reorder(race_cat, percent))  %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 9),
        text = element_text(family = "Knockout"),
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "none",
        legend.text = element_text(size = 11),
        strip.text = element_text(size = 11),
         axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_fill_manual(values = c("#abadb0","#f79548","#00aeff","#3b4982"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2019,2022,1), 
                     labels = c("'19","'20","'21","'22")) +
  facet_wrap2(vars(borough), axes = "x", nrow = 2) +
  geom_text(aes(label = ifelse(percent > 3, sprintf("%d%%", percent), "")), size = 2.8, position = position_fill(vjust = 0.5), color = "white", fontface = "bold", family = "Knockout")
  


setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_3.3.tiff", width = 7, height = 4)


```



```{r}

PD_census_boro_race <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  mutate(borough = case_when(borough == "bronx" ~ "Bronx",
                          borough == "kings" ~ "Brooklyn",
                          borough == "manhattan" ~ "Manhattan",
                          borough == "queens" ~ "Queens",
                          borough == "si" ~ "Staten Island")) %>% 
  group_by(year, borough, race) %>% 
  summarise(total_pop = sum(value))

```


```{r}

oath_yearly_boro_race <- oath %>% 
        mutate(race_cat = case_when(race_cat == "White" ~ "nhwhite",
                          race_cat == "Black" ~ "nhblack",
                          race_cat == "Hispanic" ~ "hispanic",
                          TRUE ~ "Other")) %>% 
  filter(race_cat != "Other",
         !is.na(race_cat),
         !is.na(borough),
         age > 9) %>% 
  count(year, borough, race_cat)

```

```{r}

boro_ratio <- left_join(oath_yearly_boro_race, PD_census_boro_race,  by = c("year" = "year", "borough" = "borough", "race_cat" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, borough, race_cat, rate)  %>%  
  pivot_wider(names_from = race_cat, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, borough, race, value) %>% 
  mutate(race = fct_relevel(race,"Hispanic/white","Black/white"))  
  
  
  
   ggplot(boro_ratio,
          aes(year, value, fill = race, label = value)) +
  geom_chicklet(stat = "identity", position = "dodge", width = 0.7, key_glyph = draw_key_point) +
  theme_classic() +
  theme(legend.position = "top",
        axis.text = element_text(size = 8.5),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_blank(),
        legend.key=element_blank(),
        text = element_text(family = "Knockout"),
        legend.text = element_text(size = 11),
        strip.text = element_text(size = 10),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '', fill = '') +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 4)) +
  scale_x_continuous(breaks = seq(2019,2022,1), 
                     labels = c("'19","'20","'21","'22")) +
  scale_fill_manual(values = c("#3b4982", "#00aeff")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  facet_wrap2(vars(borough), axes = "x", nrow = 3, scales = "free") +
  easy_remove_y_axis(what = c("line", "ticks")) +
     geom_text(position = position_dodge(width = 0.7),
               aes(label = ifelse(value > 1 & boro_ratio$borough == "Bronx" , sprintf("%.1f", value), "")),
               color = "white", 
               fontface = "bold",
               size = 3,
               vjust = 1.2) +
          geom_text(position = position_dodge(width = 0.7),
               aes(label = ifelse(value > 1 & boro_ratio$borough == "Brooklyn" , sprintf("%.1f", value), "")),
               color = "white", 
               fontface = "bold",
               size = 3,
               vjust = 1.2) +
               geom_text(position = position_dodge(width = 0.7),
               aes(label = ifelse(value < 1.1 & boro_ratio$borough == "Brooklyn" , sprintf("%.1f", value), "")),
               color = "black", 
               size = 3,
               vjust = -.3)+
          geom_text(position = position_dodge(width = 0.7),
               aes(label = ifelse(value > 1 & boro_ratio$borough == "Manhattan" , sprintf("%.1f", value), "")),
               color = "white", 
               fontface = "bold",
               size = 3,
               vjust = 1.2)+
                geom_text(position = position_dodge(width = 0.7),
               aes(label = ifelse(value > 4 & boro_ratio$borough == "Queens" , sprintf("%.1f", value), "")),
               color = "white", 
               fontface = "bold",
               size = 3,
               vjust = 1.2) +
              geom_text(position = position_dodge(width = 0.7),
               aes(label = ifelse(value < 5 & boro_ratio$borough == "Queens" , sprintf("%.1f", value), "")),
               color = "black", 
               size = 3,
               vjust = -.3)+
              geom_text(position = position_dodge(width = 0.7),
               aes(label = ifelse(value > 10 & boro_ratio$borough == "Staten Island" , sprintf("%.1f", value), "")),
               color = "white",
               fontface = "bold",
               size = 3,
               vjust = 1.2) +
                  geom_text(position = position_dodge(width = 0.7),
               aes(label = ifelse(value <= 10 & boro_ratio$borough == "Staten Island" , sprintf("%.1f", value), "")),
               color = "black", 
               size = 3,
               vjust = -.3) +
     expand_limits(y = 4)
   


setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_3.4.tiff", width = 7, height = 4)

```



```{r}

oath %>% 
  filter(!is.na(race_cat)) %>% 
  mutate(race = fct_relevel(race_cat, "Additional Groups", "White", "Black", "Hispanic"))  %>% 
  mutate(law = fct_relevel(law, "Open Container of Alcohol", "Public Urination", "Parks Offenses","Noise", "Littering/Spitting")) %>% 
  group_by(year, law, race) %>%
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 10),
                axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm"),
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "none",
        text = element_text(family = "Knockout"),
        legend.text = element_text(size = 11),
        strip.text = element_text(size = 10)) +
  scale_fill_manual(values = c("#abadb0","#f79548","#00aeff","#3b4982"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2013,2022,1), 
                     labels = c("'13","'14","'15","'16","'17","'18","'19","'20","'21","'22")) +
  facet_wrap2(vars(law), axes = "x", nrow = 2) +
  geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic", "White") & percent > 4, sprintf("%d%%", percent), "")), size = 2.9, position = position_fill(vjust = 0.5), color = "white", fontface = "bold", font = "Knockout")



setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_3.5.tiff", width = 7, height = 4)

```



```{r}

oath_yearly_law_race <- oath %>% 
      mutate(race_cat = case_when(race_cat == "White" ~ "nhwhite",
                          race_cat == "Black" ~ "nhblack",
                          race_cat == "Hispanic" ~ "hispanic",
                          TRUE ~ "Other")) %>% 
  filter(race_cat != "Other",
         !is.na(race_cat),
         age > 9) %>% 
  count(year, law, race_cat)

```


```{r}

left_join(oath_yearly_law_race, PD_census_race,  by = c("year" = "year", "race_cat" = "race")) %>%
  mutate(rate = (n/total_pop)*100000) %>% 
    mutate(law = fct_relevel(law, "Open Container of Alcohol", "Public Urination", "Parks Offenses","Noise", "Littering/Spitting")) %>% 
  select(year, law, race_cat, rate)  %>%  
  pivot_wider(names_from = race_cat, values_from = rate) %>% 
  mutate(`Black/white` = nhblack/nhwhite,
         `Hispanic/white` = hispanic/nhwhite) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, law, race, value) %>%
  mutate(race = fct_relevel(race,"Hispanic/white","Black/white")) %>% 
  ggplot(aes(year, value, fill = race, label = value)) +
  geom_chicklet(stat = "identity", position = "dodge", width = 0.7,  key_glyph = draw_key_point) +
  theme_classic() +
  theme(legend.position = "top",
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_blank(),
        legend.key=element_blank(),
        text = element_text(family = "Knockout"),
        legend.text = element_text(size = 11),
        axis.text = element_text(size = 10),
        strip.text = element_text(size = 10),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '', fill = '') +
  scale_y_continuous(breaks = pretty_breaks(n = 3)) +
  scale_x_continuous(breaks = 2019:2022) +
  scale_fill_manual(values = c("#233267", "#2CAAE2")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
    geom_text(position = position_dodge(width = 0.7),
            aes(label = sprintf("%.1f", value)),
            vjust = 1.2,
            color = "white",
            fontface = "bold",
            size = 2.8) +
  facet_wrap2(vars(law), axes = "x", scales = "free", nrow = 3) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  expand_limits(y = 5)
  

setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_3.6.tiff", width = 7.25, height = 4.25)


```




```{r}


oath %>% 
  filter(!is.na(race_cat)) %>% 
  filter(!is.na(sex)) %>% 
  mutate(sex = case_when(sex == "F" ~ "Women",
                         sex == "M" ~ "Men")) %>% 
  mutate(sex = fct_relevel(sex, "Women", "Men")) %>%
  group_by(year, sex, race_cat) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent)) %>% 
  mutate(race = fct_relevel(race_cat, "Additional Groups", "White", "Black", "Hispanic"))  %>% 
  ggplot(aes(x = year, y = percent, fill = race)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
  theme_classic() +
  theme(axis.text = element_text(size = 10),
        panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "none",
         text = element_text(family = "Knockout"),
         legend.text = element_text(size = 11),
        strip.text = element_text(size = 11),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_fill_manual(values = c("#abadb0","#f79548","#00aeff","#3b4982"), name = "", guide = guide_legend(reverse = TRUE)) +
  labs(y = '', x = '', color = '') +
  easy_remove_y_axis(what = c("line", "ticks")) +
  scale_y_continuous(labels = NULL) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  scale_x_continuous(breaks = seq(2019,2022,1), 
                     labels = c("'19","'20","'21","'22")) +
  facet_wrap2(vars(sex), axes = "x") +
  geom_text(aes(label = ifelse(race %in% c("Black", "Hispanic", "White"), sprintf("%d%%", percent), "")), size = 3, position = position_fill(vjust = 0.5), color = "white", fontface = "bold")

setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_3.7.tiff", width = 7, height = 2.5)

```



```{r}

PD_census_sex_race <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  group_by(year, sex, race) %>% 
  summarise(total_pop = sum(value))


```


```{r}

oath_yearly_sex_race <- oath %>% 
  mutate(race_cat = case_when(race_cat == "White" ~ "nhwhite",
                          race_cat == "Black" ~ "nhblack",
                          race_cat == "Hispanic" ~ "hispanic",
                          TRUE ~ "Other")) %>% 
  mutate(sex = case_when(sex == "F" ~ "female",
                         sex == "M" ~ "male")) %>% 
  mutate(sex = fct_relevel(sex, "female", "male")) %>%
  filter(race_cat != "Other",
         !is.na(race_cat),
         age > 9) %>% 
  count(year, sex, race_cat)

```

```{r}

left_join(oath_yearly_sex_race, PD_census_sex_race,  by = c("year" = "year", "sex" = "sex", "race_cat" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, sex, race_cat, rate)  %>%  
  pivot_wider(names_from = race_cat, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, sex, race, value) %>% 
  mutate(race = fct_relevel(race,"Hispanic/white","Black/white")) %>% 
  filter(!is.na(sex)) %>% 
  mutate(sex = case_when(sex == "female" ~ "Women",
                         sex == "male" ~ "Men")) %>% 
    mutate(sex = fct_relevel(sex, "Women", "Men")) %>%
   ggplot(aes(year, value, fill = race, label = value)) +
  geom_chicklet(stat = "identity", position = "dodge", width = 0.7,  key_glyph = draw_key_point) +
  theme_classic() +
  theme(legend.position = "top",
        axis.text = element_text(size = 10),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_blank(),
        legend.key=element_blank(),
        text = element_text(family = "Knockout"),
        legend.text = element_text(size = 11),
        strip.text = element_text(size = 11),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")
        ) +
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '', fill = '') +
  scale_y_continuous(labels = NULL) +
  scale_x_continuous(breaks = seq(2019,2022,1), 
                     labels = c("'19","'20","'21","'22")) +
  scale_fill_manual(values = c("#3b4982", "#00aeff")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
    geom_text(position = position_dodge(width = 0.7),
            aes(label = sprintf("%.1f", value)),
            vjust = -.4,
            color = "black",
            fontface = "bold",
            size = 2.9,
            family = "Knockout") +
  facet_wrap2(vars(sex), axes = "x", nrow = 1) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  expand_limits(y = 5.7)

setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_3.8.tiff", width = 7, height = 2.5)


```



```{r}

PD_census_age_race <- census_PD_projected %>% 
  filter(age_group > 2) %>% 
  mutate(age_cat = case_when(age_group >= 3 & age_group <= 5 ~ "<25",
                             age_group >= 6 & age_group <= 9 ~ "25-44",
                             age_group >= 10 ~ "45+")) %>% 
  group_by(year, age_cat, race) %>% 
  summarise(total_pop = sum(value))

```


```{r}

oath_yearly_age_race <- oath %>% 
  mutate(race_cat = case_when(race_cat == "White" ~ "nhwhite",
                          race_cat == "Black" ~ "nhblack",
                          race_cat == "Hispanic" ~ "hispanic",
                          TRUE ~ "Other")) %>% 
  filter(race != "Other",
         !is.na(age_cat)) %>% 
  count(year, age_cat, race_cat)


```


```{r}

left_join(oath_yearly_age_race, PD_census_age_race,  by = c("year" = "year", "age_cat" = "age_cat", "race_cat" = "race")) %>% 
  mutate(rate = round((n/total_pop)*100000),1) %>% 
  select(year, age_cat, race_cat, rate)  %>%  
  pivot_wider(names_from = race_cat, values_from = rate) %>% 
  mutate(`Black/white` = round(nhblack/nhwhite,1),
         `Hispanic/white` = round(hispanic/nhwhite,1)) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, age_cat, race, value) %>% 
  mutate(race = fct_relevel(race,"Hispanic/white","Black/white")) %>% 
  filter(!is.na(age_cat)) %>% 
   ggplot(aes(year, value, fill = race, label = value)) +
  geom_chicklet(stat = "identity", position = "dodge", width = 0.7,key_glyph = draw_key_point) +
  theme_classic() +
  theme(legend.position = "top",
        axis.text = element_text(size = 10),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_blank(),
        legend.key=element_blank(),
        text = element_text(family = "Knockout"),
        legend.text = element_text(size = 11),
         strip.text = element_text(size = 11),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")
        ) +
  scale_y_continuous(labels = NULL)+
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '', fill = '') +
  scale_x_continuous(breaks = seq(2019,2022,1), 
                     labels = c("'19","'20","'21","'22")) +
  scale_fill_manual(values = c("#3b4982", "#00aeff")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
    geom_text(position = position_dodge(width = 0.7),
            aes(label = sprintf("%.1f", value)),
            vjust = -.4,
            color = "black",
            size = 2.7,
            family = "Knockout") +
  facet_wrap2(vars(age_cat), axes = "x", nrow = 1) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  expand_limits(y = 10)


setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_3.9.tiff", width = 7, height = 2.5)

```



```{r}

top_zip <- oath %>% 
  filter(year == "2022") %>% 
  filter(!is.na(mod_zip_location)) %>% 
  count(mod_zip_location) %>% 
  slice_max(n, n =  5) %>% 
  pull(mod_zip_location)


oath %>% 
  filter(year == "2022") %>% 
  filter(!is.na(mod_zip_location)) %>% 
  count(mod_zip_location) %>% 
  slice_max(n, n =  5) %>% 
  mutate(sum = sum(n))


\

```

```{r}

library(sf)
library(ggrepel)
setwd("C:/R Projects/civil")
zip_codes <- read_sf("MOD_ZIP/")


oath %>% 
  filter(year == "2022") %>% 
  filter(!is.na(mod_zip_location)) %>% 
           count(mod_zip_location) %>% 
  left_join(zip_codes, by = c("mod_zip_location" = "modzcta")) %>% 
   ggplot(aes(fill = n, 
              geometry = geometry)) +
  geom_sf() +
  scale_fill_stepsn(colors = c("white","#3b4982","#00aeff"), 
                    breaks = c(50, 100, 200, 500,1000,1500,2000,2500), 
                    labels = scales::comma)+
  theme_map() +
  theme_void()+
  coord_sf(crs = st_crs(2263)) +
  theme(legend.position = "right",
        text = element_text(family = "Knockout")) +
  labs(fill = '', 
       family = "Knockout") 
  
  
    #  geom_label_repel(aes(label = ifelse(mod_zip_location %in% top_zip, as.character(mod_zip_location), "")), 
    #             size = 1.65, 
    #             color = "black", 
    #             fontface = "bold",
    #   stat = "sf_coordinates",
    # min.segment.length = 0)


setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_4.1.tiff", width = 7, height = 4)


```




```{r}


oath %>% 
  filter(!is.na(location_quintile_flag)) %>% 
  mutate(loc_quintile = case_when(location_quintile_flag == 1 ~ "1st (<=$55,313)",
                                  location_quintile_flag == 2 ~ "2nd",
                                  location_quintile_flag == 3 ~ "3rd",
                                  location_quintile_flag == 4 ~ "4th",
                                  location_quintile_flag == 5 ~ "5th (>=$109,934)")) %>% 
  mutate(loc_quintile = fct_relevel(loc_quintile, "5th (>=$109,934)", "4th", "3rd", "2nd", "1st (<=$55,313)")) %>% 
  group_by(year, loc_quintile) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  ggplot(aes(year, percent, fill = loc_quintile)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
 geom_text(aes(label = ifelse(percent > 3, 
                              sprintf("%.1f%%", percent), "")), 
           size = 4, 
           position = position_fill(vjust = 0.5), 
           color = "white", 
           fontface = "bold",
           family = "Knockout") +
  theme_classic() +
  theme(panel.grid.major = element_blank(), 
        axis.text = element_text(size = 11),
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "none",
        text = element_text(family = "Knockout"),
        legend.text = element_text(size = 11),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_x_continuous(breaks = 2013: 2022)  +
  scale_fill_manual(values = c("#abadb0","#419D78","#f79548","#00aeff","#3b4982"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks"))
  

setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_4.2.tiff", width = 5.75, height = 3.25)



```




```{r}

  
pop_quint <- med_income %>%   
  select(nhblack, nhwhite, hispanic, location_quintile_flag) %>% 
    pivot_longer(cols = c("nhblack", "hispanic", "nhwhite"), names_to = "race") %>% 
    mutate(loc_quintile_flag = case_when(location_quintile_flag == 1 ~ "1st (<=$55,313)",
                                  location_quintile_flag == 2 ~ "2nd",
                                  location_quintile_flag == 3 ~ "3rd",
                                  location_quintile_flag == 4 ~ "4th",
                                  location_quintile_flag == 5 ~ "5th (>=$109,934)")) %>%
  group_by(loc_quintile_flag, race) %>% 
  summarise(sum_pop_race = sum(value)) 



```

```{r}

oath_yearly_quint_race <- oath %>% 
      mutate(race_cat = case_when(race_cat == "White" ~ "nhwhite",
                          race_cat == "Black" ~ "nhblack",
                          race_cat == "Hispanic" ~ "hispanic",
                          TRUE ~ "Other")) %>% 
  filter(!is.na(location_quintile_flag)) %>% 
  mutate(loc_quintile = case_when(location_quintile_flag == 1 ~ "1st (<=$55,313)",
                                  location_quintile_flag == 2 ~ "2nd",
                                  location_quintile_flag == 3 ~ "3rd",
                                  location_quintile_flag == 4 ~ "4th",
                                  location_quintile_flag == 5 ~ "5th (>=$109,934)")) %>%
  filter(race_cat != "Other",
         !is.na(race_cat),
         age > 9) %>% 
  count(year, loc_quintile, race_cat)

```



```{r}


left_join(oath_yearly_quint_race, pop_quint,  by = c("loc_quintile" = "loc_quintile_flag", "race_cat" = "race")) %>% 
  mutate(rate = (n/sum_pop_race)*100000) %>% 
  select(year, loc_quintile, race_cat, rate)  %>%  
  pivot_wider(names_from = race_cat, values_from = rate) %>% 
  mutate(`Black/white` = nhblack/nhwhite,
         `Hispanic/white` = hispanic/nhwhite) %>% 
  pivot_longer(cols = c(`Black/white`, `Hispanic/white`), names_to = "race") %>% 
  select(year, loc_quintile, race, value) %>%
  mutate(race = fct_relevel(race,"Hispanic/white","Black/white")) %>% 
  ggplot(aes(year, value, fill = race, label = value)) +
  geom_chicklet(stat = "identity", 
                position = "dodge", 
                width = 0.7, 
                key_glyph = draw_key_point) +
  theme_classic() +
  theme(legend.position = "top",
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_blank(),
        legend.key=element_blank(),
        text = element_text(family = "Knockout"),
        axis.text = element_text(size = 9),
        legend.text = element_text(size = 11),
        strip.text = element_text(size = 11),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_y_continuous(labels = NULL)+
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '', fill = '') +
  scale_x_continuous(breaks = 2019:2022) +
  scale_fill_manual(values = c("#3b4982", "#00aeff")) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
  geom_text(position = position_dodge(width = 0.7),
            aes(label = sprintf("%.1f", value)),
            vjust = -.3,
            color = "black",
            fontface = "bold",
            size = 2.6,
            family = "Knockout") +
  facet_wrap2(vars(loc_quintile), nrow= 2) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  expand_limits(y =17)

setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_4.3.tiff", width = 7, height = 4)


```




```{r}


oath %>% 
  mutate(loc_quintile = case_when(location_quintile_flag == 1 ~ "1st (<=$55,313)",
                                  location_quintile_flag == 2 ~ "2nd",
                                  location_quintile_flag == 3 ~ "3rd",
                                  location_quintile_flag == 4 ~ "4th",
                                  location_quintile_flag == 5 ~ "5th (>=$109,934)")) %>%
  select(loc_quintile, mod_zip_location, year, nhblack, nhwhite, hispanic) %>% 
  filter(!is.na(mod_zip_location)) %>% 
  distinct(mod_zip_location, .keep_all = TRUE) %>%
  pivot_longer(cols = c("nhblack", "hispanic", "nhwhite"), names_to = "race") %>% 
  group_by(loc_quintile, year, race) %>% 
  summarise(pop = sum(value))
  



  
```


```{r}

oath %>%
         filter(fine_imposed > 0) %>%
mutate(fine_cat = case_when(fine_imposed <=25 ~ "<=$25",
                            fine_imposed >25 & fine_imposed <= 100 ~ "$26-$100",
                            fine_imposed > 99 ~ ">$100")) %>% 
  mutate(fine_cat = fct_relevel(fine_cat, ">$100", "$26-$100","<=$25")) %>% 
  group_by(year, fine_cat) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  ggplot(aes(year, percent, fill = fine_cat)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
 geom_text(aes(label = ifelse(percent > 3, 
                              sprintf("%.1f%%", percent), "")), 
           size = 3.5, 
           position = position_fill(vjust = 0.5), 
           color = "white", 
           fontface = "bold",
           family = "Knockout") +
  theme_classic() +
  theme(panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "none",
        text = element_text(family = "Knockout"),
         axis.text = element_text(size = 11),
        legend.text = element_text(size = 11),
         axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_x_continuous(breaks = 2013: 2022)  +
  scale_fill_manual(values = c("#f79548","#00aeff","#3b4982"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks"))
  
setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_5.1.tiff", width = 6, height = 3)


```

```{r}

oath %>%
  filter(fine_imposed > 0) %>%
  filter(race_cat %in% c("Black", "Hispanic", "White")) %>% 
mutate(fine_cat = case_when(fine_imposed <=25 ~ "<=$25",
                            fine_imposed >25 & fine_imposed <= 100 ~ "$26-$100",
                            fine_imposed > 99 ~ ">$100")) %>% 
  mutate(fine_cat = fct_relevel(fine_cat, ">$100", "$26-$100","<=$25")) %>% 
  group_by(year, race_cat, fine_cat) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  ggplot(aes(year, percent, fill = fine_cat)) +
  geom_bar(stat = "identity", position = "fill", width = 0.85, key_glyph = draw_key_point) +
 geom_text(aes(label = ifelse(percent > 3, 
                              sprintf("%.1f%%", percent), "")), 
           size = 3, 
           position = position_fill(vjust = 0.5), 
           color = "white", 
           fontface = "bold",
           family = "Knockout") +
  theme_classic() +
  theme(panel.grid.major = element_blank(), 
        axis.text.y=element_blank(), 
        plot.background = element_rect(fill = "NA"), 
        panel.background = element_rect(fill = "NA"), 
        legend.background  = element_rect(fill = "white", color = NA), 
        legend.position = "none",
         text = element_text(family = "Knockout"),
        axis.text = element_text(size = 10),
        legend.text = element_text(size = 11),
         strip.text = element_text(size = 10),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")
        ) +
  scale_x_continuous(breaks = 2013: 2022)  +
  scale_fill_manual(values = c("#f79548","#00aeff","#3b4982"), name = "") +
  labs(y = '', x = '', color = '') +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks"))+
  facet_wrap(~race_cat, nrow = 1)


setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_5.2.tiff", width = 6, height = 3)

```


```{r}


oath %>% 
  filter(!is.na(race_cat)) %>% 
  mutate(race_cat = fct_relevel(race_cat, "Additional Groups", "White", "Black", "Hispanic")) %>% 
  group_by(year,race_cat) %>% 
  summarise(sum_fine = sum(fine_imposed)) %>% 
  group_by(year) %>% 
  mutate(sum_year = sum(sum_fine)) %>% 
  ggplot(aes(x = year, y = sum_fine, fill = race_cat)) +
  geom_col(width = .97, key_glyph = draw_key_point) +
  theme_classic()+
  theme(legend.background = element_rect(fill = "white"),
        legend.position = "none",
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_blank(),
        legend.key=element_blank(),
        text = element_text(family = "Knockout"),
        axis.text = element_text(size = 11),
        legend.text = element_text(size = 11),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm"))+
  scale_y_continuous(labels = comma)+
  scale_fill_manual(values = c("#abadb0","#f79548","#00aeff","#3b4982"), name = "") +
  labs(y = '', x = '', color = '') +
  scale_y_continuous(labels = NULL) +
  scale_x_continuous(breaks = 2013: 2022) +
  guides(fill = guide_legend(reverse = TRUE, override.aes = list(shape = 21, size = 5))) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  expand_limits(y = 460000)+
  geom_text(aes(y = sum_year, 
                label = comma(sum_year)), 
            vjust = -.85, 
            size = 3.1, 
            family = "Knockout",
            format = comma, 
            check_overlap = TRUE,  
            fontface = "bold") +
   geom_text(aes(x = year, 
                 y = sum_fine, 
                 label = comma(sum_fine), ""), 
             size = 3, position = position_stack(vjust = 0.5), color = "white", fontface = "bold", family = "Knockout")


setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_5.3.tiff", width = 5.75, height = 3.25)


```




```{r}

# density experiment

oath %>%
  filter(fine_imposed > 0) %>%
  filter(race_cat %in% c("Black", "Hispanic", "White")) %>% 
  ggplot(aes(x = fine_imposed, fill = race_cat)) +
  geom_density(alpha = 0.1, position = "identity")


```



```{r}

FTA_overall <- oath %>%
    filter(race_cat %in% c("Black", "Hispanic", "White")) %>% 
 group_by(year, ever_FTA) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  mutate(race_cat = "Overall")

oath %>%
    filter(race_cat %in% c("Black", "Hispanic", "White")) %>% 
 group_by(year, race_cat, ever_FTA) %>% 
  summarise(n = n()) %>% 
  mutate(percent = n / sum(n) * 100) %>% 
  mutate(percent = round(percent, 1)) %>% 
  bind_rows(FTA_overall) %>% 
    mutate(race_cat = as.factor(race_cat),
           race_cat = fct_relevel(race_cat,"Black", "Hispanic", "White", "Overall")) %>% 
  filter(ever_FTA == "Y") %>% 
  ggplot(aes(year, percent, fill = race_cat, label = percent)) +
  geom_chicklet(stat = "identity", position = "dodge", width = 0.7, key_glyph = draw_key_point) +
  theme_classic()+
   theme(legend.position = "top",
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        plot.title = element_text(size = 12),
        panel.grid.major.y = element_blank(),
        legend.key=element_blank(),
        text = element_text(family = "Knockout"),
        axis.text = element_text(size = 10),
        legend.text = element_text(size = 11),
        axis.line.x = element_line(size = .05),
         axis.ticks.x=element_line(size=.05),
    axis.ticks.length.x = unit(.35, "cm")) +
  scale_y_continuous(labels = comma)+
  xlab("") +
  expand_limits(y = 0) +
  labs(y = '', x = '', color = '', fill = '') +
  scale_y_continuous(labels = NULL) +
  scale_x_continuous(breaks = 2019:2022) +
  easy_remove_y_axis(what = c("line", "ticks")) +
  guides(fill = guide_legend(override.aes = list(shape = 21, size = 5)))+
    geom_text(position = position_dodge(width = 0.7),
            aes(label = sprintf("%.1f%%", percent)),
            vjust = -.3,
            color = "black",
            size = 2.3,
            family = "Knockout",
            fontface = "bold") +
  easy_remove_y_axis(what = c("line", "ticks")) +
    scale_fill_manual(values = c("#3b4982", "#00aeff", "#f79548", "#abadb0"), name = "") 



  
setwd("C:/R Projects/civil/graphs")
ggsave("oath_figure_5.4.tiff", width = 6.25, height = 3.25)


```

